name: CI

on:
  pull_request:
    types: [opened, synchronize, labeled]
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Increase timeout for ESP-IDF toolchain downloads
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all history for nx affected to work

      - name: Fetch base branch
        run: git fetch origin main:main

      - name: Set NX SHAs for affected detection
        uses: nrwl/nx-set-shas@v4
        id: set-shas
        with:
          main-branch-name: main

      - name: Build and test in dev container
        uses: devcontainers/ci@v0.3
        env:
          NX_BASE: ${{ steps.set-shas.outputs.base }}
          NX_HEAD: ${{ steps.set-shas.outputs.head }}
        with:
          push: never
          runCmd: |
            nx affected --target=build
            nx affected --target=lint
            nx affected --target=test
          env: |
            NX_BASE
            NX_HEAD
